<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZKD - قارئ المانهوا</title>
  <meta name="theme-color" content="#000000"/>
  <meta name="description" content="تطبيق قراءة المانهوا باللغة العربية - تجربة قراءة سلسة مثل تطبيق جوال"/>

  <!-- أيقونات وخط -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet"/>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --primary-bg:#000;--secondary-bg:#0a0a0a;--card-bg:#111;--accent-color:#fff;
      --text-primary:#fff;--text-secondary:#a0a0a0;--success:#00c896;--warn:#ffcc00;--error:#ff2e4d;
      --nav-h:70px;--r:16px;--t:0.3s;--sidebar:280px
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;-webkit-tap-highlight-color:transparent}
    :focus{outline:none}
    :focus-visible{outline:none}
    html,body{height:100%}
    body{background:var(--primary-bg);color:var(--text-primary);overflow:hidden}

    /* الحاوية العامة */
    .app{height:100%;display:flex;flex-direction:column}

    /* المحتوى */
    .main{flex:1;overflow:auto;padding:20px;padding-bottom:calc(var(--nav-h) + 24px)}

    /* شاشة الدخول */
    .auth{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;z-index:1000}
    .auth.hidden{display:none}
    .auth .logo{width:140px;height:140px;border-radius:50%;border:3px solid #fff;display:grid;place-items:center;background:#222;margin-bottom:24px}
    .auth .logo i{font-size:60px}
    .auth .title{font-size:32px;font-weight:900;margin-bottom:8px}
    .auth .sub{color:var(--text-secondary);margin-bottom:20px}
    .auth .btns{display:flex;flex-direction:column;gap:12px;width:min(320px,90%)}
    .btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:14px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-2px)}
    .btn.google{background:#fff;color:#222}
    .btn.guest{background:rgba(255,255,255,.06);color:#fff}
    .btn i{min-width:16px;text-align:center}

    /* رأس الصفحة الرئيسية + البحث + تبويبات */
    .home-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .logo-text{font-size:28px;font-weight:900}
    .avatar{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;border:2px solid #fff;background:#222;cursor:pointer}
    .search{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:12px 16px;margin-bottom:18px}
    .search input{flex:1;background:transparent;border:0;color:#fff;font-size:16px}
    .tabs{display:flex;gap:8px;overflow:auto;padding:6px 0 14px}
    .tab{padding:8px 16px;border-radius:999px;background:#111;border:1px solid rgba(255,255,255,.12);cursor:pointer;font-weight:600;white-space:nowrap}
    .tab.active{background:#222;border-color:#fff}

    /* شبكة المانهوا */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media(min-width:768px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(4,1fr)}}
    .card{background:var(--card-bg);border:1px solid rgba(255,255,255,.12);border-radius:var(--r);overflow:hidden;cursor:pointer;transition:.2s;position:relative}
    .card:hover{transform:translateY(-4px);border-color:rgba(255,255,255,.3)}
    .cover{width:100%;height:200px;background:#222;display:block;object-fit:cover}
    .badge{position:absolute;top:10px;left:10px;background:#222;border:1px solid #fff;color:#fff;font-weight:700;font-size:12px;border-radius:999px;padding:4px 10px}
    .card .info{padding:12px}
    .title{font-size:16px;font-weight:800;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .meta{font-size:13px;color:var(--text-secondary);margin-top:6px}

    /* صفحة التفاصيل */
    .detail{display:none}
    .detail .header-btn{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);background:#111;color:#fff;border-radius:8px;padding:10px 12px;cursor:pointer;margin-bottom:16px}
    .detail .hero{width:100%;height:300px;border-radius:var(--r);object-fit:cover;background:#222;margin-bottom:16px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 16px}
    .chip{background:#111;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;font-size:13px}
    .actions{display:flex;gap:10px;margin:14px 0 20px}
    .action-lg{flex:1;border:1px solid rgba(255,255,255,.12);background:#111;color:#fff;border-radius:10px;padding:12px;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:700;cursor:pointer}
    .action-lg.active{background:var(--success);color:#000}
    .chapters .row{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.12);background:#111;border-radius:var(--r);padding:12px;margin-bottom:10px}
    .row:hover{border-color:rgba(255,255,255,.3)}
    .row .left{display:flex;align-items:center;gap:10px}
    .dot{width:20px;height:20px;border-radius:50%;display:grid;place-items:center;background:#333;font-size:12px}
    .dot.read{background:var(--success);color:#000}

    /* التعليقات */
    .comments{margin-top:24px}
    .comments .form{display:flex;gap:10px;margin-bottom:12px}
    .comments .form input{flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff}
    .comments .form button{border:0;border-radius:8px;background:var(--success);color:#000;font-weight:800;padding:0 14px;cursor:pointer}
    .comment{border:1px solid rgba(255,255,255,.12);background:#111;border-radius:var(--r);padding:12px;margin-bottom:10px}
    .comment .h{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .avatar-sm{width:30px;height:30px;border-radius:50%;background:#222;display:grid;place-items:center;font-size:12px;font-weight:800}

    /* الملف الشخصي */
    .profile{display:none}
    .p-head{display:flex;flex-direction:column;align-items:center;margin-bottom:20px}
    .p-ava{width:100px;height:100px;border:3px solid #fff;border-radius:50%;display:grid;place-items:center;background:#222;position:relative;margin-bottom:10px}
    .p-ava .edit{position:absolute;right:-6px;bottom:-6px;width:32px;height:32px;border:2px solid #fff;border-radius:50%;display:grid;place-items:center;background:#333;cursor:pointer}
    .p-name{font-size:22px;font-weight:900}
    .p-email{color:var(--text-secondary);margin-top:4px}
    .p-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:20px 0;width:100%}
    .stat{border:1px solid rgba(255,255,255,.12);background:#111;border-radius:var(--r);padding:14px;text-align:center}
    .stat .v{font-size:20px;font-weight:900}
    .plist{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:768px){.plist{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:1024px){.plist{grid-template-columns:repeat(4,1fr)}}
    .plist .item{border:1px solid rgba(255,255,255,.12);background:#111;border-radius:var(--r);overflow:hidden}
    .plist .item img{height:120px;width:100%;object-fit:cover;background:#222}
    .plist .iinfo{padding:10px}
    .plist .ttl{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .plist .sub{font-size:12px;color:var(--text-secondary)}

    /* الإعدادات */
    .settings{display:none}
    .settings .h2{font-size:24px;font-weight:900;margin-bottom:14px}
    .sg{border:1px solid rgba(255,255,255,.12);background:#111;border-radius:var(--r);padding:16px;margin-bottom:14px}
    .sg .t{font-weight:800;margin-bottom:10px;border-bottom:1px solid rgba(255,255,255,.12);padding-bottom:8px}
    .si{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.08);padding:12px 0}
    .si:last-child{border-bottom:0}
    .si input[type="text"],.si input[type="email"],.si select{width:220px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:10px;color:#fff}
    .switch{position:relative;width:50px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;inset:0;border-radius:24px;background:#333;transition:.3s}
    .slider:before{content:"";position:absolute;left:4px;bottom:4px;width:16px;height:16px;border-radius:50%;background:#fff;transition:.3s}
    input:checked + .slider{background:var(--success)}
    input:checked + .slider:before{transform:translateX(26px)}

    /* لوحة الإدارة */
    .admin{display:none}
    .admin .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .admin .tabs{display:flex;gap:8px;overflow:auto;margin:6px 0 12px}
    .admin .atab{padding:8px 14px;border:1px solid rgba(255,255,255,.12);background:#111;border-radius:8px;cursor:pointer;white-space:nowrap}
    .admin .atab.active{background:#222;border-color:#fff}
    .admin .section{display:none}
    .admin .section.active{display:block}
    .alist .item{display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(255,255,255,.12);background:#111;border-radius:var(--r);padding:12px;margin-bottom:10px}
    .form .fg{margin-bottom:12px}
    .form .fg label{display:block;margin-bottom:6px;font-weight:700}
    .form .fg input,.form .fg textarea,.form .fg select{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff}

    /* القارئ */
    .reader{position:fixed;inset:0;background:#000;display:none;z-index:2000}
    .r-top{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:16px;background:linear-gradient(to bottom,rgba(0,0,0,.9),transparent)}
    .r-body{height:calc(100% - 120px);overflow:auto;display:flex;flex-direction:column;align-items:center;padding:16px 0}
    .r-page{width:100%;max-width:980px;margin-bottom:10px;border-radius:8px;overflow:hidden}
    .r-page img{display:block;width:100%;height:auto}
    .r-bottom{position:sticky;bottom:0;display:flex;align-items:center;justify-content:space-between;padding:16px;background:linear-gradient(to top,rgba(0,0,0,.9),transparent)}
    .r-next{position:fixed;left:50%;transform:translateX(-50%);bottom:100px;background:var(--success);color:#000;padding:12px 18px;border-radius:999px;font-weight:900;display:none}

    /* الشريط السفلي */
    .nav{position:fixed;left:0;right:0;bottom:0;height:var(--nav-h);display:flex;align-items:center;justify-content:space-around;background:rgba(10,10,10,.95);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.12);z-index:1500}
    .nitem{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--text-secondary);padding:8px;cursor:pointer;position:relative}
    .nitem.active{color:#fff}
    .nitem.active:after{content:"";position:absolute;bottom:-5px;width:6px;height:6px;border-radius:50%;background:#fff}

    /* القائمة الجانبية */
    .sidebar{position:fixed;top:0;right:-280px;width:280px;height:100%;background:var(--secondary-bg);z-index:1600;transition:right .3s;padding:16px;overflow:auto;box-shadow:-5px 0 15px rgba(0,0,0,.25)}
    .sidebar.open{right:0}
    .s-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .s-list{display:flex;flex-direction:column;gap:8px}
    .sitem{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;cursor:pointer;transition:.2s}
    .sitem:hover{background:#111}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1550}
    .overlay.active{display:block}

    /* حالة فارغة */
    .empty{grid-column:1/-1;text-align:center;padding:40px;color:var(--text-secondary)}
    .empty i{font-size:50px;margin-bottom:8px;opacity:.6}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- شاشة الدخول -->
    <section class="auth" id="auth">
      <div class="logo"><i class="fas fa-book-open"></i></div>
      <div class="title">ZKD - قارئ المانهوا</div>
      <p class="sub">سجّل الدخول للوصول إلى مكتبتك</p>
      <div class="btns">
        <button class="btn google" id="btn-google"><i class="fab fa-google"></i><span>التسجيل بحساب Google</span></button>
        <button class="btn guest" id="btn-guest"><i class="fas fa-user"></i><span>الدخول كزائر</span></button>
      </div>
    </section>

    <!-- المحتوى -->
    <main class="main" id="main">
      <!-- الرئيسية -->
      <section id="home" class="home">
        <div class="home-header">
          <div class="logo-text">ZKD</div>
          <div class="avatar" id="btn-profile"><i class="fas fa-user"></i></div>
        </div>
        <div class="search">
          <i class="fas fa-search"></i>
          <input id="search-input" type="text" placeholder="ابحث عن مانهوا أو فصل..." />
        </div>
        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="all">الكل</button>
          <button class="tab" data-tab="popular">الأكثر شهرة</button>
          <button class="tab" data-tab="latest">الأحدث</button>
          <button class="tab" data-tab="action">أكشن</button>
          <button class="tab" data-tab="romance">رومانسي</button>
        </div>
        <div class="grid" id="grid"></div>
      </section>

      <!-- التفاصيل -->
      <section id="detail" class="detail">
        <button class="header-btn" id="back-from-detail"><i class="fas fa-arrow-right"></i> رجوع</button>
        <img id="detail-cover" class="hero" alt="cover"/>
        <h1 id="detail-title" class="title" style="font-size:24px;margin-bottom:6px"></h1>
        <div class="chips">
          <span class="chip" id="d-status"></span>
          <span class="chip" id="d-chapters"></span>
          <span class="chip" id="d-views"></span>
        </div>
        <p id="detail-desc" style="color:var(--text-secondary);line-height:1.7;margin-bottom:12px"></p>
        <div class="chips" id="detail-tags"></div>
        <div class="actions">
          <button id="btn-watchlater" class="action-lg"><i class="far fa-bookmark"></i> أشاهدها لاحقاً</button>
          <button id="btn-watching" class="action-lg"><i class="far fa-eye"></i> أشاهدها الآن</button>
        </div>
        <h3 style="margin:10px 0 8px">الفصول</h3>
        <div class="chapters" id="chapters"></div>

        <div class="comments">
          <h3 style="margin-bottom:10px">التعليقات</h3>
          <div class="form">
            <input id="comment-input" type="text" placeholder="اكتب تعليقك هنا..."/>
            <button id="btn-comment">إرسال</button>
          </div>
          <div id="comments"></div>
        </div>
      </section>

      <!-- الملف الشخصي -->
      <section id="profile" class="profile">
        <button class="header-btn" id="back-from-profile"><i class="fas fa-arrow-right"></i> رجوع</button>
        <div class="p-head">
          <div class="p-ava" id="p-ava"><span id="p-ava-text">US</span><div class="edit" id="btn-change-ava"><i class="fas fa-camera"></i></div></div>
          <div class="p-name" id="p-name">مستخدم</div>
          <div class="p-email" id="p-email">user@example.com</div>
        </div>
        <div class="p-stats">
          <div class="stat"><div class="v" id="st-watching">0</div><div>أشاهدها</div></div>
          <div class="stat"><div class="v" id="st-watchlater">0</div><div>المحفوظة</div></div>
          <div class="stat"><div class="v" id="st-completed">0</div><div>المكتملة</div></div>
        </div>
        <div style="font-weight:800;margin:10px 0 8px;display:flex;justify-content:space-between;align-items:center">
          <span>أشاهدها الآن</span><button class="header-btn" id="btn-all-watching">عرض الكل</button>
        </div>
        <div class="plist" id="list-watching"></div>
        <div style="font-weight:800;margin:18px 0 8px;display:flex;justify-content:space-between;align-items:center">
          <span>سأشاهدها لاحقاً</span><button class="header-btn" id="btn-all-watchlater">عرض الكل</button>
        </div>
        <div class="plist" id="list-watchlater"></div>
      </section>

      <!-- الإعدادات -->
      <section id="settings" class="settings">
        <div class="h2">الإعدادات</div>

        <div class="sg">
          <div class="t">الحساب</div>
          <div class="si">
            <label>الاسم</label>
            <div>
              <input type="text" id="set-name" placeholder="اسمك"/>
              <button class="header-btn" id="btn-save-profile">حفظ</button>
            </div>
          </div>
          <div class="si"><label>البريد الإلكتروني</label><span id="set-email">—</span></div>
          <div class="si"><label>طريقة التسجيل</label><span id="set-method">—</span></div>
        </div>

        <div class="sg">
          <div class="t">إعدادات القراءة</div>
          <div class="si"><label>وضع رأسي</label><label class="switch"><input type="checkbox" id="opt-vertical" checked/><span class="slider"></span></label></div>
          <div class="si"><label>تنزيل تلقائي</label><label class="switch"><input type="checkbox" id="opt-autodl"/><span class="slider"></span></label></div>
          <div class="si"><label>إشعارات الفصول الجديدة</label><label class="switch"><input type="checkbox" id="opt-notif" checked/><span class="slider"></span></label></div>
        </div>

        <div class="sg">
          <div class="t">المظهر</div>
          <div class="si">
            <label>الوضع الليلي</label>
            <label class="switch"><input type="checkbox" id="opt-dark" checked/><span class="slider"></span></label>
          </div>
          <div class="si">
            <label>حجم الخط</label>
            <select id="opt-font">
              <option value="small">صغير</option>
              <option value="medium" selected>متوسط</option>
              <option value="large">كبير</option>
            </select>
          </div>
        </div>

        <div class="sg">
          <div class="t">عام</div>
          <div class="si"><label>إصدار التطبيق</label><span>1.0.0</span></div>
          <div class="si"><button class="header-btn" id="btn-clear-cache"><i class="fas fa-trash"></i> مسح الذاكرة المؤقتة</button></div>
          <div class="si"><button class="header-btn" id="btn-signout"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button></div>
        </div>
      </section>

      <!-- لوحة الإدارة -->
      <section id="admin" class="admin">
        <div class="head">
          <div style="font-size:22px;font-weight:900">لوحة التحكم</div>
          <div class="avatar" id="btn-close-admin"><i class="fas fa-times"></i></div>
        </div>

        <div class="tabs" id="admin-tabs">
          <button class="atab active" data-sec="a-dash"><i class="fas fa-gauge"></i> لوحة التحكم</button>
          <button class="atab" data-sec="a-manhwas"><i class="fas fa-book"></i> المانهوا</button>
          <button class="atab" data-sec="a-chaps"><i class="fas fa-file"></i> الفصول</button>
          <button class="atab" data-sec="a-users"><i class="fas fa-users"></i> المستخدمون</button>
          <button class="atab" data-sec="a-reports"><i class="fas fa-flag"></i> التبليغات</button>
          <button class="atab" data-sec="a-chat"><i class="fas fa-comments"></i> محادثة</button>
        </div>

        <!-- Dashboard -->
        <div class="section active" id="a-dash">
          <div class="form" style="margin-bottom:12px">
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
              <div class="stat"><div class="v" id="ad-man">0</div><div>عدد المانهوا</div></div>
              <div class="stat"><div class="v" id="ad-chp">0</div><div>عدد الفصول</div></div>
              <div class="stat"><div class="v" id="ad-usr">0</div><div>عدد المستخدمين</div></div>
              <div class="stat"><div class="v" id="ad-views">0</div><div>المشاهدات</div></div>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
            <button class="header-btn" id="btn-quick-add"><i class="fas fa-plus"></i> إضافة مانهوا</button>
            <button class="header-btn" id="btn-quick-chp"><i class="fas fa-edit"></i> إضافة فصل</button>
          </div>
        </div>

        <!-- إدارة المانهوا -->
        <div class="section" id="a-manhwas">
          <div class="form" id="form-add-manhwa">
            <h3 style="margin-bottom:10px">إضافة مانهوا جديدة</h3>
            <div class="fg"><label>اسم المانهوا</label><input type="text" id="f-title" required/></div>
            <div class="fg"><label>الوصف</label><textarea id="f-desc" rows="4" required></textarea></div>
            <div class="fg"><label>التصنيفات (مفصولة بفواصل)</label><input type="text" id="f-tags" placeholder="أكشن, رومانسي, خيال"/></div>
            <div class="fg"><label>الحالة</label><select id="f-status"><option value="ongoing">مستمرة</option><option value="completed">مكتملة</option></select></div>
            <div class="fg">
              <label>صورة الغلاف (Storage: bucket=covers)</label>
              <input type="file" id="f-cover" accept="image/*"/>
            </div>
            <button class="header-btn" id="btn-add-manhwa">إضافة</button>
          </div>

          <div style="margin:12px 0;font-weight:800">قائمة المانهوا</div>
          <div class="alist" id="admin-manhwa-list"></div>
        </div>

        <!-- إدارة الفصول -->
        <div class="section" id="a-chaps">
          <div class="form">
            <h3 style="margin-bottom:10px">إضافة فصل</h3>
            <div class="fg"><label>المانهوا</label><select id="ch-man"></select></div>
            <div class="fg"><label>رقم الفصل</label><input type="number" id="ch-num" min="1"/></div>
            <div class="fg"><label>عنوان (اختياري)</label><input type="text" id="ch-title"/></div>
            <div class="fg"><label>صفحات (Storage: bucket=chapters)</label><input type="file" id="ch-pages" accept="image/*" multiple/></div>
            <button class="header-btn" id="btn-add-chapter">رفع الفصل</button>
          </div>
          <div style="margin:12px 0;font-weight:800">قائمة الفصول</div>
          <div class="alist" id="admin-chapter-list"></div>
        </div>

        <!-- المستخدمون -->
        <div class="section" id="a-users">
          <div class="alist" id="admin-user-list"></div>
        </div>

        <!-- التبليغات -->
        <div class="section" id="a-reports">
          <div class="alist" id="admin-report-list"></div>
        </div>

        <!-- محادثة الإداريين -->
        <div class="section" id="a-chat">
          <div class="form">
            <div class="fg"><label>رسالة جديدة</label><input type="text" id="admin-chat-input" placeholder="اكتب رسالة..."/></div>
            <button class="header-btn" id="btn-admin-send">إرسال</button>
          </div>
          <div style="margin:12px 0;font-weight:800">الرسائل</div>
          <div class="alist" id="admin-chat-list"></div>
        </div>
      </section>
    </main>

    <!-- القارئ -->
    <section class="reader" id="reader">
      <div class="r-top">
        <i class="fas fa-arrow-right" id="btn-close-reader"></i>
        <div id="reader-title">—</div>
        <i class="fas fa-ellipsis-vertical" id="btn-reader-menu"></i>
      </div>
      <div class="r-body" id="reader-body"></div>
      <div class="r-bottom">
        <i class="fas fa-cog" id="btn-reader-settings"></i>
        <div>
          <i class="fas fa-chevron-right" id="btn-next"></i>
          <i class="fas fa-chevron-left" id="btn-prev"></i>
        </div>
        <i class="fas fa-download" id="btn-download"></i>
      </div>
      <button class="r-next" id="btn-next-chapter">الفصل التالي <i class="fas fa-arrow-left"></i></button>
    </section>

    <!-- الشريط السفلي -->
    <nav class="nav" id="nav">
      <div class="nitem active" data-go="home"><i class="fas fa-home"></i><span>الرئيسية</span></div>
      <div class="nitem" data-go="search"><i class="fas fa-search"></i><span>بحث</span></div>
      <div class="nitem" id="nav-bookmarks"><i class="fas fa-bookmark"></i><span>المحفوظات</span></div>
      <!-- إصلاح مهم: النقر العادي يفتح الإعدادات + الضغط المطوّل (١.٥ث) يفتح لوحة الإدارة إن كنت مدير -->
      <div class="nitem" id="nav-settings"><i class="fas fa-cog"></i><span>الإعدادات</span></div>
    </nav>

    <!-- القائمة الجانبية -->
    <aside class="sidebar" id="sidebar">
      <div class="s-head">
        <div style="font-weight:900">القائمة</div>
        <div id="side-close"><i class="fas fa-times"></i></div>
      </div>
      <div class="s-list">
        <div class="sitem" data-go="home"><i class="fas fa-home"></i><span>الرئيسية</span></div>
        <div class="sitem" id="side-profile"><i class="fas fa-user"></i><span>الملف الشخصي</span></div>
        <div class="sitem" data-go="settings"><i class="fas fa-cog"></i><span>الإعدادات</span></div>
        <div class="sitem" id="side-bookmarks"><i class="fas fa-bookmark"></i><span>المحفوظات</span></div>
        <div class="sitem" id="side-history"><i class="fas fa-history"></i><span>السجل</span></div>
        <div class="sitem" id="side-downloads"><i class="fas fa-download"></i><span>التحميلات</span></div>
        <div class="sitem" id="side-notifs"><i class="fas fa-bell"></i><span>الإشعارات</span></div>
        <div class="sitem" id="side-help"><i class="fas fa-question-circle"></i><span>المساعدة</span></div>
        <div class="sitem" id="side-signout"><i class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></div>
      </div>
    </aside>
    <div class="overlay" id="overlay"></div>
  </div>

  <script>
    /***** تهيئة Supabase *****/
    const supabaseUrl = 'https://dnhzgduojexngvconytx.supabase.co'; // حدّث إذا لزم
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRuaHpnZHVvamV4bmd2Y29ueXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NjM1NDYsImV4cCI6MjA3MTIzOTU0Nn0.84PMLVTIc-zbKqiBxG3sl1PSOi0Zqg8gaUAr4Go3Z38'; // حدّث إذا لزم
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    /***** حالة التطبيق *****/
    let user = null, isGuest = false, isAdmin = false;
    let manhwas = [];
    let currentManhwa = null;
    let currentChapter = null;
    let currentPageIndex = 0;

    // قائمة المدراء
    const adminEmails = ['mohammedznger@gmail.com','admin@zkd.com'];

    // عناصر DOM
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);

    /***** أدوات *****/
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const fmt = (n)=> new Intl.NumberFormat('ar').format(n||0);
    const safe = (s)=> (s??'').toString();

    function setActiveNav(id){
      $$('.nitem').forEach(n=>n.classList.remove('active'));
      const el = (id==='search')? $('[data-go="home"]') : $(`.nitem[data-go="${id}"]`) || $(`#nav-${id}`);
      (el||$('.nitem[data-go="home"]')).classList.add('active');
    }
    function showSection(id){
      // الرئيسية/التفاصيل/البروفايل/الإعدادات/الإدارة
      ['home','detail','profile','settings','admin'].forEach(s=> $(`#${s}`).style.display = (s===id?'block':'none'));
      if(id!=='reader') setActiveNav(id);
      if(id==='home'){ $('#search-input')?.blur(); }
    }

    function emptyState(container, text='لا توجد عناصر متاحة حالياً'){
      container.innerHTML = `
        <div class="empty"><i class="fas fa-book-open"></i><div>${text}</div></div>
      `;
    }

    function avatarText(name,email){
      const base = (name||email||'مستخدم').trim();
      const parts = base.split(' ');
      const t = (parts[0]?.[0]||'').toUpperCase() + (parts[1]?.[0]||'').toUpperCase();
      return t || 'US';
    }

    /***** مصادقة *****/
    async function initAuth(){
      const { data } = await sb.auth.getSession();
      if(data?.session){
        await onSignedIn(data.session.user);
      }
      // مراقبة تغيّر الجلسة
      sb.auth.onAuthStateChange(async (event, session)=>{
        if(event==='SIGNED_IN' && session) await onSignedIn(session.user);
        if(event==='SIGNED_OUT') await onSignedOut();
      });
    }

    async function onSignedIn(u){
      user = u; isGuest=false;
      isAdmin = adminEmails.includes((user.email||'').toLowerCase());
      $('#auth').classList.add('hidden');
      await ensureProfileRow();
      await loadAll();
      showSection('home');
      updateProfileUI();
    }

    async function onSignedOut(){
      user = null; isAdmin=false; isGuest=false;
      $('#auth').classList.remove('hidden');
      showSection('home');
      $('#grid').innerHTML = '';
    }

    async function signInGoogle(){
      await sb.auth.signInWithOAuth({provider:'google', options:{redirectTo: window.location.origin}});
    }
    async function signInGuest(){
      // وضع الزائر: بدون إدخال بيانات لقاعدة البيانات — فقط عرض واجهة فارغة
      isGuest=true; user={id:'guest',email:'guest@zkd.com',user_metadata:{full_name:'زائر'}};
      $('#auth').classList.add('hidden'); await loadAll(); showSection('home'); updateProfileUI();
    }
    async function signOut(){
      if(!isGuest){ await sb.auth.signOut(); }
      await onSignedOut();
    }

    async function ensureProfileRow(){
      if(isGuest) return;
      const email = user.email;
      const name = user.user_metadata?.full_name || email?.split('@')[0] || 'مستخدم';
      const { data: rows } = await sb.from('profiles').select('id').eq('id', user.id).maybeSingle();
      if(!rows){
        await sb.from('profiles').insert({ id: user.id, email, name, avatar_url: null });
      }
    }

    /***** تحميل البيانات *****/
    async function loadAll(){
      await loadManhwas();
      if(isAdmin){ refreshAdminStats(); loadAdminLists(); }
    }

    async function loadManhwas(){
      const cont = $('#grid');
      cont.innerHTML = '';
      const { data, error } = await sb.from('manhwas').select('*').order('created_at',{ascending:false});
      if(error){ console.error(error); emptyState(cont,'تعذر تحميل المانهوا'); return; }
      manhwas = data||[];
      if(!manhwas.length){ emptyState(cont,'لا توجد مانهوا بعد'); return; }
      renderManhwas(manhwas);
    }

    function renderManhwas(list){
      const cont = $('#grid'); cont.innerHTML='';
      if(!list.length){ emptyState(cont,'لا نتائج مطابقة'); return; }
      list.forEach(m=>{
        const d = document.createElement('div');
        d.className='card';
        const watching = !!m.user_is_watching; // يمكنك احتسابها عبر VIEW أو جلب مستقل
        const watchLater = !!m.user_is_watchlater;
        d.innerHTML = `
          ${watching? `<div class="badge" style="left:auto;right:10px;background:var(--success)">أشاهدها</div>`:''}
          ${watchLater? `<div class="badge" style="left:auto;right:10px;background:var(--warn)">محفوظة</div>`:''}
          ${m.status==='new'? `<div class="badge">جديد</div>`:''}
          <img class="cover" src="${safe(m.cover_url)}" alt="${safe(m.title)}" onerror="this.style.display='none'"/>
          <div class="info">
            <div class="title">${safe(m.title)}</div>
            <div class="meta">الفصل ${m.latest_chapter||1}</div>
          </div>
        `;
        d.addEventListener('click',()=>openManhwa(m));
        cont.appendChild(d);
      });
    }

    // بحث وتبويب
    $('#search-input').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      const list = !q? manhwas : manhwas.filter(m=> safe(m.title).toLowerCase().includes(q) || safe(m.tags).toLowerCase().includes(q));
      renderManhwas(list);
    });
    $('#tabs').addEventListener('click',(e)=>{
      const b = e.target.closest('.tab'); if(!b) return;
      $$('#tabs .tab').forEach(t=>t.classList.remove('active')); b.classList.add('active');
      const id = b.dataset.tab;
      let list=[...manhwas];
      if(id==='popular') list.sort((a,b)=>(b.views||0)-(a.views||0));
      if(id==='latest') list.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      if(id==='action') list = manhwas.filter(m=> (m.tags||'').includes('أكشن'));
      if(id==='romance') list = manhwas.filter(m=> (m.tags||'').includes('رومانسي'));
      renderManhwas(list);
    });

    /***** تفاصيل المانهوا *****/
    async function openManhwa(m){
      currentManhwa = m;
      showSection('detail');
      $('#detail-cover').src = safe(m.cover_url)||'';
      $('#detail-title').textContent = safe(m.title);
      $('#d-status').textContent = (m.status==='completed'?'مكتملة':'مستمرة');
      $('#d-chapters').textContent = `الفصول: ${m.latest_chapter||1}`;
      $('#d-views').textContent = `المشاهدات: ${fmt(m.views||0)}`;
      $('#detail-desc').textContent = safe(m.description)||'';
      const tags = $('#detail-tags'); tags.innerHTML='';
      (safe(m.tags)||'').split(',').map(t=>t.trim()).filter(Boolean).forEach(t=>{
        const s = document.createElement('span'); s.className='chip'; s.textContent=t; tags.appendChild(s);
      });
      updateActionButtons();

      // تحميل الفصول
      const chCont = $('#chapters'); chCont.innerHTML='';
      const { data: chapters } = await sb.from('chapters').select('*').eq('manhwa_id', m.id).order('chapter_number',{ascending:false});
      if(!chapters?.length){ chCont.innerHTML = `<div class="empty">لا توجد فصول بعد</div>`; return; }
      chapters.forEach(c=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `
          <div class="left"><div class="dot">${c.is_read?'<i class="fas fa-check"></i>':''}</div>
          <div>الفصل ${c.chapter_number}${c.title? ' — ' + safe(c.title): ''}</div></div>
          <div class="right"><button class="header-btn" data-ch="${c.id}"><i class="fas fa-book-open"></i> قراءة</button></div>
        `;
        row.querySelector('button').addEventListener('click',()=>openReader(c));
        chCont.appendChild(row);
      });

      // التعليقات
      await renderComments();
    }

    function updateActionButtons(){
      const wlBtn = $('#btn-watchlater');
      const wBtn  = $('#btn-watching');
      wlBtn.classList.remove('active'); wBtn.classList.remove('active');
      wlBtn.innerHTML = '<i class="far fa-bookmark"></i> أشاهدها لاحقاً';
      wBtn.innerHTML  = '<i class="far fa-eye"></i> أشاهدها الآن';
      // ملاحظة: يمكنك جلب حالة القوائم للمستخدم من جدول user_lists
    }

    $('#btn-watchlater').addEventListener('click', async ()=>{
      if(!currentManhwa || isGuest) return;
      await sb.from('user_lists').upsert({ user_id:user.id, manhwa_id: currentManhwa.id, list:'watch_later' }, { onConflict:'user_id,manhwa_id' });
      updateProfileLists();
      updateActionButtons();
    });
    $('#btn-watching').addEventListener('click', async ()=>{
      if(!currentManhwa || isGuest) return;
      await sb.from('user_lists').upsert({ user_id:user.id, manhwa_id: currentManhwa.id, list:'watching' }, { onConflict:'user_id,manhwa_id' });
      updateProfileLists();
      updateActionButtons();
    });

    $('#back-from-detail').addEventListener('click', ()=> showSection('home'));

    /***** التعليقات *****/
    async function renderComments(){
      const ctn = $('#comments'); ctn.innerHTML='';
      const { data } = await sb.from('comments').select('id,content,created_at,profiles(name)').eq('manhwa_id', currentManhwa.id).order('created_at',{ascending:false});
      if(!data?.length){ ctn.innerHTML='<div class="empty">لا توجد تعليقات</div>'; return; }
      data.forEach(cm=>{
        const d = document.createElement('div'); d.className='comment';
        d.innerHTML = `
          <div class="h"><div class="avatar-sm">${avatarText(cm.profiles?.name,'')}</div><div style="font-weight:800">${cm.profiles?.name||'—'}</div><div style="margin-right:auto;color:var(--text-secondary);font-size:12px">${new Date(cm.created_at).toLocaleString('ar')}</div></div>
          <div>${safe(cm.content)}</div>
        `;
        ctn.appendChild(d);
      });
    }
    $('#btn-comment').addEventListener('click', async ()=>{
      if(isGuest || !currentManhwa) return;
      const val = $('#comment-input').value.trim(); if(!val) return;
      await sb.from('comments').insert({ manhwa_id: currentManhwa.id, user_id: user.id, content: val });
      $('#comment-input').value=''; await renderComments();
    });

    /***** القارئ *****/
    async function openReader(chapter){
      currentChapter = chapter; currentPageIndex=0;
      $('#reader').style.display='block';
      $('#reader-title').textContent = `الفصل ${chapter.chapter_number}`;
      await renderReaderPages();
    }
    function closeReader(){ $('#reader').style.display='none'; }
    $('#btn-close-reader').addEventListener('click', closeReader);

    async function renderReaderPages(){
      const body = $('#reader-body'); body.innerHTML='';
      // جلب الصفحات من جدول chapter_pages المرتبط بالفصل
      const { data: pages } = await sb.from('chapter_pages').select('*').eq('chapter_id', currentChapter.id).order('page_number');
      if(!pages?.length){ body.innerHTML = '<div class="empty">لا توجد صفحات</div>'; return; }
      pages.forEach(p=>{
        const d = document.createElement('div'); d.className='r-page';
        d.innerHTML = `<img src="${safe(p.image_url)}" alt="page ${p.page_number}" />`;
        body.appendChild(d);
      });
    }
    $('#btn-next').addEventListener('click',()=> $('#reader-body').scrollBy({top:600,behavior:'smooth'}));
    $('#btn-prev').addEventListener('click',()=> $('#reader-body').scrollBy({top:-600,behavior:'smooth'}));

    /***** الملف الشخصي *****/
    function updateProfileUI(){
      const name = isGuest? 'زائر' : (user.user_metadata?.full_name || user.email?.split('@')[0] || 'مستخدم');
      $('#p-name').textContent = name;
      $('#p-email').textContent = isGuest? 'guest@zkd.com' : (user.email||'');
      $('#p-ava-text').textContent = avatarText(name, user.email);
      $('#set-name').value = name;
      $('#set-email').textContent = isGuest? '—' : (user.email||'—');
      $('#set-method').textContent = isGuest? 'زائر' : 'OAuth (Google)';
      updateProfileLists();
    }

    async function updateProfileLists(){
      $('#list-watching').innerHTML=''; $('#list-watchlater').innerHTML='';
      if(isGuest) { return; }
      const { data: lists } = await sb.from('user_lists').select('list, manhwas(id,title,cover_url,latest_chapter)').eq('user_id',user.id);
      const watching = lists?.filter(x=>x.list==='watching').map(x=>x.manhwas) || [];
      const later    = lists?.filter(x=>x.list==='watch_later').map(x=>x.manhwas) || [];
      $('#st-watching').textContent = fmt(watching.length);
      $('#st-watchlater').textContent = fmt(later.length);
      $('#st-completed').textContent = '0';
      const fill = (list, el)=> list.forEach(m=>{
        const d = document.createElement('div'); d.className='item';
        d.innerHTML = `<img src="${safe(m.cover_url)}" alt=""/><div class="iinfo"><div class="ttl">${safe(m.title)}</div><div class="sub">الفصل ${m.latest_chapter||1}</div></div>`;
        d.addEventListener('click',()=>openManhwa(m));
        el.appendChild(d);
      });
      fill(watching,$('#list-watching')); fill(later,$('#list-watchlater'));
    }

    // حفظ الاسم
    $('#btn-save-profile').addEventListener('click', async ()=>{
      if(isGuest) return;
      const name = $('#set-name').value.trim(); if(!name) return;
      await sb.from('profiles').update({ name }).eq('id', user.id);
      user.user_metadata = {...user.user_metadata, full_name: name};
      updateProfileUI();
    });

    /***** الإعدادات وعناصر التنقل *****/
    // إصلاح زر الإعدادات: النقر يفتح الإعدادات + Long Press 1.5s يفتح الإدارة إن كنت مدير
    (function fixSettingsButton(){
      const el = $('#nav-settings');
      let timer = null, pressed=false;
      const onDown = ()=>{
        pressed=true;
        timer = setTimeout(()=>{ if(pressed) openAdminIfAllowed(); }, 1500);
      };
      const onUp = ()=>{
        if(timer) clearTimeout(timer);
        if(pressed){ showSection('settings'); } // نقر عادي
        pressed=false;
      };
      el.addEventListener('mousedown', onDown);
      el.addEventListener('touchstart', onDown, {passive:true});
      el.addEventListener('mouseup', onUp);
      el.addEventListener('mouseleave', ()=>{ pressed=false; clearTimeout(timer); });
      el.addEventListener('touchend', onUp);
    })();

    async function openAdminIfAllowed(){
      if(!user || isGuest){ return; }
      if(!isAdmin){ alert('ليس لديك صلاحية الإدارة'); return; }
      showSection('admin');
      refreshAdminStats();
      loadAdminLists();
    }

    // أيقونات الشريط
    $('#nav').addEventListener('click', (e)=>{
      const item = e.target.closest('.nitem'); if(!item) return;
      const go = item.dataset.go;
      if(go==='search'){ // ينقلك للرئيسية ويركّز البحث
        showSection('home'); $('#search-input').focus();
      } else if(go){ showSection(go); }
      if(item.id==='nav-bookmarks'){ /* يمكنك لاحقاً فتح قائمة المحفوظات */ }
    });

    // صورة البروفايل
    $('#btn-profile').addEventListener('click', ()=> showSection('profile'));
    $('#back-from-profile').addEventListener('click', ()=> showSection('home'));

    // أزرار الدخول/الخروج
    $('#btn-google').addEventListener('click', signInGoogle);
    $('#btn-guest').addEventListener('click', signInGuest);
    $('#btn-signout').addEventListener('click', signOut);

    // إعدادات عامة
    $('#btn-clear-cache').addEventListener('click', ()=>{ localStorage.clear(); alert('تم مسح الذاكرة المؤقتة'); });

    /***** لوحة الإدارة *****/
    $('#btn-close-admin').addEventListener('click', ()=> showSection('home'));
    $('#admin-tabs').addEventListener('click',(e)=>{
      const t = e.target.closest('.atab'); if(!t) return;
      $$('#admin-tabs .atab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const id = t.dataset.sec;
      $$('.admin .section').forEach(s=> s.classList.remove('active'));
      $(`#${id}`).classList.add('active');
    });
    $('#btn-quick-add').addEventListener('click',()=>{ $$('.atab').forEach(x=>x.classList.remove('active')); $('[data-sec="a-manhwas"]').classList.add('active'); $$('.admin .section').forEach(s=> s.classList.remove('active')); $('#a-manhwas').classList.add('active'); });
    $('#btn-quick-chp').addEventListener('click',()=>{ $$('.atab').forEach(x=>x.classList.remove('active')); $('[data-sec="a-chaps"]').classList.add('active'); $$('.admin .section').forEach(s=> s.classList.remove('active')); $('#a-chaps').classList.add('active'); });

    async function refreshAdminStats(){
      const [{ count: m }, { count: c }, { count: u }] = await Promise.all([
        sb.from('manhwas').select('*',{count:'exact', head:true}),
        sb.from('chapters').select('*',{count:'exact', head:true}),
        sb.from('profiles').select('*',{count:'exact', head:true})
      ]);
      $('#ad-man').textContent=fmt(m||0);
      $('#ad-chp').textContent=fmt(c||0);
      $('#ad-usr').textContent=fmt(u||0);
      // إجمالي المشاهدات
      const { data: vw } = await sb.rpc('total_views'); // دالة SQL اختيارية
      $('#ad-views').textContent=fmt(vw?.[0]?.sum||0);
    }

    async function loadAdminLists(){
      // قائمة المانهوا
      const { data: list } = await sb.from('manhwas').select('id,title,status,latest_chapter,views,cover_url').order('created_at',{ascending:false});
      const cont = $('#admin-manhwa-list'); cont.innerHTML='';
      (list||[]).forEach(m=>{
        const d = document.createElement('div'); d.className='item';
        d.innerHTML = `<div><div style="font-weight:800">${safe(m.title)}</div><div style="color:var(--text-secondary);font-size:13px">الفصول ${m.latest_chapter||1} • ${fmt(m.views||0)} مشاهدة</div></div>
        <div style="display:flex;gap:8px"><button class="header-btn" data-ed="${m.id}"><i class="fas fa-pen"></i></button><button class="header-btn" data-del="${m.id}"><i class="fas fa-trash"></i></button></div>`;
        d.querySelector('[data-del]').addEventListener('click', async ()=>{
          if(confirm('حذف المانهوا؟ سيُحذف كل ما يتعلق بها.')){ await sb.from('manhwas').delete().eq('id', m.id); await loadAdminLists(); await loadManhwas(); }
        });
        d.querySelector('[data-ed]').addEventListener('click', async ()=>{
          const newTitle = prompt('اسم جديد', m.title); if(!newTitle) return;
          await sb.from('manhwas').update({ title:newTitle }).eq('id', m.id); await loadAdminLists(); await loadManhwas();
        });
        cont.appendChild(d);
      });

      // تعبئة قائمة المانهوا لإضافة الفصول
      const sel = $('#ch-man'); sel.innerHTML='';
      (list||[]).forEach(m=>{
        const opt = document.createElement('option'); opt.value=m.id; opt.textContent=m.title; sel.appendChild(opt);
      });

      // قائمة الفصول
      const { data: chs } = await sb.from('chapters').select('id,chapter_number,title,manhwa_id,manhwas(title)').order('created_at',{ascending:false});
      const ctn = $('#admin-chapter-list'); ctn.innerHTML='';
      (chs||[]).forEach(c=>{
        const d = document.createElement('div'); d.className='item';
        d.innerHTML = `<div><div style="font-weight:800">${safe(c.manhwas?.title)} — الفصل ${c.chapter_number}${c.title? ' • '+safe(c.title):''}</div></div>
        <div><button class="header-btn" data-delch="${c.id}"><i class="fas fa-trash"></i></button></div>`;
        d.querySelector('[data-delch]').addEventListener('click', async ()=>{
          if(confirm('حذف الفصل؟')){ await sb.from('chapters').delete().eq('id', c.id); await loadAdminLists(); }
        });
        ctn.appendChild(d);
      });

      // المستخدمون
      const { data: users } = await sb.from('profiles').select('id,name,email').order('created_at',{ascending:false});
      const uctn = $('#admin-user-list'); uctn.innerHTML='';
      (users||[]).forEach(u=>{
        const d = document.createElement('div'); d.className='item';
        d.innerHTML = `<div><div style="font-weight:800">${safe(u.name||'—')}</div><div style="color:var(--text-secondary);font-size:13px">${safe(u.email)}</div></div>`;
        uctn.appendChild(d);
      });

      // التبليغات
      const { data: reps } = await sb.from('reports').select('*').order('created_at',{ascending:false});
      const rctn = $('#admin-report-list'); rctn.innerHTML='';
      (reps||[]).forEach(r=>{
        const d = document.createElement('div'); d.className='item';
        d.innerHTML = `<div><div style="font-weight:800">${safe(r.type||'بلاغ')}</div><div style="color:var(--text-secondary);font-size:13px">${safe(r.message||'—')}</div></div>`;
        rctn.appendChild(d);
      });

      // محادثة الإدارة
      const { data: msgs } = await sb.from('admin_messages').select('id,content,created_at,profiles(name)').order('created_at',{ascending:false});
      const mctn = $('#admin-chat-list'); mctn.innerHTML='';
      (msgs||[]).forEach(ms=>{
        const d = document.createElement('div'); d.className='item';
        d.innerHTML = `<div><div style="font-weight:800">${safe(ms.profiles?.name||'—')}</div><div style="color:var(--text-secondary);font-size:13px">${new Date(ms.created_at).toLocaleString('ar')}</div><div style="margin-top:6px">${safe(ms.content)}</div></div>`;
        mctn.appendChild(d);
      });
    }

    // إضافة مانهوا (رفع غلاف إلى Storage bucket "covers")
    $('#btn-add-manhwa').addEventListener('click', async ()=>{
      const title = $('#f-title').value.trim(); const description = $('#f-desc').value.trim();
      const tags = $('#f-tags').value.trim(); const status = $('#f-status').value;
      if(!title || !description){ alert('الاسم والوصف مطلوبان'); return; }
      let cover_url = null;
      const file = $('#f-cover').files[0];
      if(file){
        const path = `${Date.now()}_${file.name}`;
        const { data: up, error } = await sb.storage.from('covers').upload(path, file);
        if(error){ alert('تعذر رفع الغلاف'); return; }
        const { data: pub } = sb.storage.from('covers').getPublicUrl(up.path);
        cover_url = pub.publicUrl;
      }
      const { error: ins } = await sb.from('manhwas').insert({ title, description, tags, status, cover_url, latest_chapter: 0, views: 0 });
      if(ins){ alert('تعذر إضافة المانهوا'); return; }
      $('#f-title').value=''; $('#f-desc').value=''; $('#f-tags').value=''; $('#f-status').value='ongoing'; $('#f-cover').value='';
      await loadAdminLists(); await loadManhwas();
    });

    // إضافة فصل (رفع الصفحات إلى Storage bucket "chapters")
    $('#btn-add-chapter').addEventListener('click', async ()=>{
      const manhwa_id = $('#ch-man').value; const chapter_number = parseInt($('#ch-num').value||'0',10);
      const title = $('#ch-title').value.trim();
      const files = Array.from($('#ch-pages').files||[]);
      if(!manhwa_id || !chapter_number || !files.length){ alert('يرجى تعبئة الحقول ورفع الصفحات'); return; }
      // أضف سجل الفصل
      const { data: ch, error: chErr } = await sb.from('chapters').insert({ manhwa_id, chapter_number, title }).select('*').single();
      if(chErr){ alert('تعذر إنشاء الفصل'); return; }
      // ارفع الصفحات
      let page_number = 1;
      for(const f of files.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true}))){
        const path = `${ch.id}/${Date.now()}_${f.name}`;
        const { data: up, error } = await sb.storage.from('chapters').upload(path, f);
        if(error){ alert('تعذر رفع صفحة'); return; }
        const { data: pub } = sb.storage.from('chapters').getPublicUrl(up.path);
        await sb.from('chapter_pages').insert({ chapter_id: ch.id, page_number, image_url: pub.publicUrl });
        page_number++;
      }
      // تحديث آخر فصل
      await sb.from('manhwas').update({ latest_chapter: chapter_number }).eq('id', manhwa_id);
      $('#ch-num').value=''; $('#ch-title').value=''; $('#ch-pages').value='';
      await loadAdminLists();
      if(currentManhwa && currentManhwa.id===manhwa_id){ openManhwa(currentManhwa); }
    });

    // إرسال رسالة إدارة
    $('#btn-admin-send').addEventListener('click', async ()=>{
      if(isGuest) return;
      const v = $('#admin-chat-input').value.trim(); if(!v) return;
      await sb.from('admin_messages').insert({ user_id:user.id, content:v });
      $('#admin-chat-input').value=''; await loadAdminLists();
    });

    /***** القائمة الجانبية *****/
    $('#side-close').addEventListener('click', ()=>{ $('#sidebar').classList.remove('open'); $('#overlay').classList.remove('active'); });
    $('#overlay').addEventListener('click', ()=>{ $('#sidebar').classList.remove('open'); $('#overlay').classList.remove('active'); });
    $('#side-profile').addEventListener('click', ()=>{ showSection('profile'); $('#sidebar').classList.remove('open'); $('#overlay').classList.remove('active'); });
    $('[data-go="home"]').addEventListener('click', ()=>{ showSection('home'); $('#sidebar').classList.remove('open'); $('#overlay').classList.remove('active'); });
    $('[data-go="settings"]').addEventListener('click', ()=>{ showSection('settings'); $('#sidebar').classList.remove('open'); $('#overlay').classList.remove('active'); });
    $('#side-signout').addEventListener('click', signOut);

    /***** بداية التشغيل *****/
    (async function(){
      // إلغاء أي "مستطيل أزرق" للضغط — تمت عبر CSS: -webkit-tap-highlight-color: transparent
      await initAuth();
    })();
  </script>
</body>
      </html>
